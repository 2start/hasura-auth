version: "3.6"
services:
  postgres:
    image: nhost/postgres:12-v0.0.5
    restart: always
    environment:
      POSTGRES_PASSWORD: "secretpgpassword"
  graphql-engine:
    image: hasura/graphql-engine:v2.0.1
    depends_on:
      - "postgres"
    restart: always
    environment:
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
      HASURA_GRAPHQL_ADMIN_SECRET: "hello123"
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:secretpgpassword@postgres:5432/postgres
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256", "key":
        "5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3"}'
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      HASURA_GRAPHQL_LOG_LEVEL: debug
    ports:
      - "8080:8080"
  hasura-auth:
    image: nhost/hasura-auth:latest
    build:
      context: ../../
      dockerfile: Dockerfile.dev
    depends_on:
      - "graphql-engine"
      - "mailhog"
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: development
      PORT: 4000
      SERVER_URL: http://localhost:4000
      DATABASE_URL: postgres://postgres:secretpgpassword@postgres:5432/postgres
      HASURA_GRAPHQL_ADMIN_SECRET: "hello123"
      HASURA_ENDPOINT: http://graphql-engine:8080/v1/graphql
      JWT_ALGORITHM: HS256
      JWT_KEY: 5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3
      REDIRECT_URL_ERROR: http://localhost:3000
      REDIRECT_URL_SUCCESS: http://localhost:3000
      EMAILS_ENABLED: "true"
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_PASS: password
      SMTP_USER: user
      SMTP_SECURE: "false"
      SMTP_SENDER: hbp@hbp.com
      ## custom test
      DEFAULT_ALLOWED_USER_ROLES: "user,me,editor"
      ALLOWED_USER_ROLES: "user,me,editor,anonymous"
      LOGGER_ENABLED: "false"
    volumes:
      - ../../:/app
      - /app/node_modules
    command: "yarn test-command"
  mailhog:
    image: mailhog/mailhog
    ports:
      - 1025:1025 # smtp server
      - 8025:8025 # web ui
